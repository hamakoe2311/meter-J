<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cycle Tech Cinema</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    /* === Base Styles & Variables === */
    :root {
      /* Colors */
      --bg-color: #0f0f0f;
      --header-bg: #1f1f1f;
      --panel-bg: rgba(20, 20, 20, 0.85);
      --text-color: #ffffff;
      --accent-color: #00ffcc; /* Meter Accent */
      --video-accent: #2196F3; /* Video Accent */
      --danger-color: #ff3333;
      
      /* Layout */
      --header-height: 56px;
      --meter-height: 380px; /* PC„Åß„ÅÆ„É°„Éº„Çø„ÉºÈ´ò„Åï */
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* === Header (Global Controls) === */
    header {
      height: var(--header-height);
      padding: 0 15px;
      background: var(--header-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
      z-index: 100;
    }
    
    h1 { margin: 0; font-size: 16px; font-weight: bold; color: var(--accent-color); letter-spacing: 1px; }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-header {
      background: #333; border: 1px solid #444; color: #eee;
      padding: 5px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;
      display: flex; align-items: center; gap: 5px; transition: 0.2s;
    }
    .btn-header:hover { background: #444; }
    
    /* File Input hidden wrapper */
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type=file] {
      position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
    }

    /* === Main Layout Container === */
    #main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto; /* Á∏¶„Çπ„ÇØ„É≠„Éº„É´Ë®±ÂèØ */
      position: relative;
    }

    /* === METER SECTION === */
    #meter-section {
      width: 100%;
      min-height: var(--meter-height);
      position: relative;
      background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-bottom: 2px solid #333;
      flex-shrink: 0;
    }

    /* Meter Elements (imported from Meter V2) */
    #clock {
      position: absolute; top: 10px; right: 20px;
      font-size: 1.5rem; color: #fff; font-weight: 300;
      font-variant-numeric: tabular-nums;
    }

    #gauge-wrapper {
      position: relative; width: 280px; height: 280px;
      display: flex; justify-content: center; align-items: center;
      margin-top: 10px;
    }
    
    svg.gauge-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: visible; }
    .gauge-track { fill: none; stroke: #222; stroke-width: 18; stroke-linecap: round; }
    
    #gauge-needle {
      position: absolute; width: 6px; height: 50%; 
      background: transparent; bottom: 50%; left: 50%;
      transform-origin: bottom center; transform: rotate(-135deg);
      transition: transform 0.1s cubic-bezier(0.1, 0, 0.3, 1);
      z-index: 2; pointer-events: none;
    }
    #gauge-needle::after {
      content: ''; position: absolute; top: 15px; left: -2px;
      width: 10px; height: 40px; background: var(--accent-color);
      border-radius: 5px; box-shadow: 0 0 15px var(--accent-color);
    }
    
    #digital-inner {
      position: absolute; z-index: 3; text-align: center;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      width: 60%; height: 60%; border-radius: 50%;
      background: radial-gradient(circle, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 80%);
    }
    #speed-val { font-size: 4.5rem; font-weight: bold; line-height: 0.9; color: var(--accent-color); font-variant-numeric: tabular-nums; letter-spacing: -2px; }
    #speed-unit { font-size: 0.9rem; color: #888; font-weight: bold; margin-top: 5px; }
    .gauge-tick-label { position: absolute; font-size: 0.9rem; color: #666; font-weight: bold; transform: translate(-50%, -50%); pointer-events: none; }

    /* Stats Grid */
    #stats-panel {
      display: grid; grid-template-columns: repeat(6, 1fr);
      gap: 10px; width: 95%; max-width: 800px;
      background: rgba(40,40,40,0.4); border-radius: 10px;
      padding: 10px; margin-bottom: 10px; backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-box { text-align: center; }
    .stat-label { font-size: 0.65rem; color: #aaa; display: block; margin-bottom: 2px; }
    .stat-value { font-size: 1.1rem; font-weight: bold; color: #fff; font-variant-numeric: tabular-nums; }
    .stat-unit { font-size: 0.6rem; color: #888; }
    
    /* Map Overlay (Hidden by default) */
    #map-view {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 5; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    #meter-section.map-active #map-view { opacity: 1; pointer-events: auto; }
    #meter-section.map-active #gauge-wrapper,
    #meter-section.map-active #stats-panel { opacity: 0; pointer-events: none; }

    .meter-toggle-btn {
      position: absolute; bottom: 10px; right: 10px; z-index: 10;
      background: rgba(0,0,0,0.7); color: var(--accent-color);
      border: 1px solid var(--accent-color); padding: 5px 15px;
      font-size: 0.8rem; cursor: pointer; border-radius: 20px;
    }

    /* Styles control */
    #meter-section.hide-analog #gauge-wrapper svg,
    #meter-section.hide-analog #gauge-needle,
    #meter-section.hide-analog .gauge-tick-label { display: none; }
    #meter-section.hide-digital #digital-inner { display: none; }

    /* === VIDEO SECTION === */
    #video-section {
      flex: 1;
      display: flex;
      flex-direction: row; /* Ê®™‰∏¶„Å≥ (PC) */
      min-height: 0;
      background: #121212;
    }

    /* Video Player Area */
    .player-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #000;
      position: relative;
    }
    .video-wrapper {
      flex: 1;
      width: 100%;
      background: #000;
      position: relative;
    }
    iframe, video { width: 100%; height: 100%; border: none; position: absolute; top:0; left:0; }

    /* Controls Bar */
    .video-controls {
      height: 50px;
      background: #181818;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      border-top: 1px solid #333;
    }
    .btn-ctrl {
      background: transparent; border: none;
      color: #fff; font-size: 20px; cursor: pointer;
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-ctrl:hover { background: rgba(255,255,255,0.1); }

    /* Playlist Sidebar */
    .playlist-sidebar {
      width: 320px;
      background: #121212;
      border-left: 1px solid #333;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .playlist-filter { padding: 10px; border-bottom: 1px solid #333; background: #181818; display:flex; gap:5px; flex-direction: column;}
    #folderSelect { width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 13px; }
    .nico-toggle { font-size: 12px; color: #ccc; display: flex; align-items: center; gap: 5px; cursor: pointer;}

    #playlist-content { flex: 1; overflow-y: auto; }
    
    .list-item {
      display: flex; gap: 10px; padding: 8px 10px;
      cursor: pointer; transition: background 0.1s;
      border-left: 3px solid transparent; border-bottom: 1px solid #222;
    }
    .list-item:hover { background: #1e1e1e; }
    .list-item.active { background: #252525; border-left-color: var(--video-accent); }
    .list-item.active .list-title { color: var(--video-accent); }

    .list-thumb-box { position: relative; width: 100px; height: 56px; flex-shrink: 0; }
    .list-thumb { width: 100%; height: 100%; object-fit: cover; background: #333; border-radius: 4px; }
    .playing-overlay {
      display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); align-items: center; justify-content: center; color: #fff; font-size: 12px;
    }
    .list-item.active .playing-overlay { display: flex; }

    .list-info { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
    .list-title { font-size: 13px; font-weight: 500; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px; }
    .list-meta { font-size: 10px; color: #888; display: flex; justify-content: space-between; }

    /* === Modals === */
    #settings-modal, #start-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9); z-index: 2000;
      display: none; justify-content: center; align-items: center;
    }
    .modal-content {
      background: #1a1a1a; padding: 20px; border-radius: 10px;
      width: 90%; max-width: 350px; border: 1px solid #444;
      max-height: 90vh; overflow-y: auto;
    }
    .modal-title { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
    
    .setting-row { margin-bottom: 15px; }
    .setting-row label { display: block; margin-bottom: 5px; color: #ccc; font-size: 0.9rem; }
    .setting-row input[type="number"], .setting-row select { width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; box-sizing: border-box; }
    
    .color-picker-wrapper { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 8px; border-radius: 4px; }
    input[type="color"] { border: none; width: 40px; height: 30px; background: none; cursor: pointer; }

    .switch-wrapper { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 8px; border-radius: 4px; }
    .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    .btn-action { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .btn-reset { background: #444; color: #ccc; }
    .btn-danger { background: #600; color: #ffaaaa; margin-top: 5px; }
    .btn-close { background: var(--accent-color); color: #000; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .btn-start { background: var(--video-accent); color: #fff; font-size: 1.2rem; padding: 15px 40px; border-radius: 50px; }

    /* === Responsive === */
    @media (max-width: 900px) {
      #main-container { overflow-y: auto; }
      #meter-section { min-height: 320px; flex-shrink: 0; }
      #stats-panel { grid-template-columns: repeat(3, 1fr); gap: 10px 5px; }
      #video-section { flex-direction: column; height: auto; flex: 0; }
      .video-wrapper { aspect-ratio: 16/9; }
      .playlist-sidebar { width: 100%; height: 300px; border-left: none; border-top: 1px solid #333; }
      .header-controls span { display: none; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <h1>CYCLE TECH CINEMA</h1>
    <div class="header-controls">
      <div class="file-input-wrapper">
        <button class="btn-header">üìÇ <span>Load JSON</span></button>
        <input type="file" id="fileInput" accept=".json">
      </div>
      <button class="btn-header" id="btn-settings">‚öôÔ∏è <span>Settings</span></button>
      <button class="btn-header" id="btn-fullscreen">‚õ∂</button>
    </div>
  </header>

  <!-- MAIN CONTAINER -->
  <div id="main-container">
    
    <!-- METER SECTION -->
    <div id="meter-section">
      <div id="clock">--:--</div>
      
      <div id="gauge-wrapper">
        <svg class="gauge-bg" viewBox="0 0 200 200">
          <path class="gauge-track" d="M 40 160 A 85 85 0 1 1 160 160" fill="none" />
        </svg>
        <div id="gauge-ticks"></div>
        <div id="gauge-needle"></div>
        <div id="digital-inner">
          <span id="speed-val">0.0</span>
          <span id="speed-unit">km/h</span>
        </div>
      </div>

      <div id="stats-panel">
        <div class="stat-box"><span class="stat-label">DIST</span><span class="stat-value" id="dist-val">0.00</span><span class="stat-unit">km</span></div>
        <div class="stat-box"><span class="stat-label">TIME</span><span class="stat-value" id="time-val">00:00</span><span class="stat-unit"></span></div>
        <div class="stat-box"><span class="stat-label">KCAL</span><span class="stat-value" id="kcal-val">0</span><span class="stat-unit">kcal</span></div>
        <div class="stat-box"><span class="stat-label">AVG</span><span class="stat-value" id="avg-val">0.0</span><span class="stat-unit">km/h</span></div>
        <div class="stat-box"><span class="stat-label">MAX</span><span class="stat-value" id="max-val">0.0</span><span class="stat-unit">km/h</span></div>
        <div class="stat-box"><span class="stat-label">ALT</span><span class="stat-value" id="alt-val">--</span><span class="stat-unit">m</span></div>
      </div>

      <div id="map-view"></div>
      <button class="meter-toggle-btn" id="btn-map-toggle">Show MAP</button>
    </div>

    <!-- VIDEO SECTION -->
    <div id="video-section">
      <div class="player-area">
        <div class="video-wrapper">
          <div id="player-container"></div>
        </div>
        <div class="video-controls">
          <button class="btn-ctrl" id="btnPrev">‚èÆ</button>
          <button class="btn-ctrl" id="btnNext">‚è≠</button>
        </div>
      </div>

      <div class="playlist-sidebar">
        <div class="playlist-filter">
          <select id="folderSelect">
            <option value="__ALL__">üìö „Åô„Åπ„Å¶„ÅÆÂãïÁîª</option>
          </select>
          <label class="nico-toggle">
            <input type="checkbox" id="excludeNicoCheck"> „Éã„Ç≥„Éã„Ç≥„ÇíÈô§Â§ñ
          </label>
        </div>
        <div id="playlist-content">
          <div style="padding:40px 20px; text-align:center; color:#666; font-size:13px;">
            JSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- OVERLAYS -->
  <div id="start-overlay">
    <button class="btn-start" id="btnUserStart">START</button>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settings-modal">
    <div class="modal-content">
      <h2 class="modal-title">Settings</h2>

      <div class="setting-row">
        <label>Ë°®Á§∫Ë®≠ÂÆö</label>
        <div class="switch-wrapper">
          <span style="font-size:0.9rem; color:#ccc;">ÊôÇË®à„ÅÆÁßíÊï∞„ÇíË°®Á§∫</span>
          <label class="toggle-switch">
            <input type="checkbox" id="input-show-seconds">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="setting-row">
        <label>‰ΩìÈáç (kg) <small>„Ç´„É≠„É™„ÉºË®àÁÆóÁî®</small></label>
        <input type="number" id="input-weight" value="60" min="30">
      </div>

      <div class="setting-row">
        <label>ÊôÇË®à„ÅÆËâ≤</label>
        <div class="color-picker-wrapper">
          <span style="font-size:0.9rem; color:#ccc;">Clock Color</span>
          <input type="color" id="input-clock-color" value="#ffffff">
        </div>
      </div>

      <div class="setting-row">
        <label>„É°„Éº„Çø„Éº„ÅÆËâ≤</label>
        <div class="color-picker-wrapper">
          <span style="font-size:0.9rem; color:#ccc;">Meter Color</span>
          <input type="color" id="input-meter-color" value="#00ffcc">
        </div>
      </div>

      <div class="setting-row">
        <label>Ë°®Á§∫„Çπ„Çø„Ç§„É´</label>
        <select id="input-style">
          <option value="hybrid">„Éè„Ç§„Éñ„É™„ÉÉ„Éâ (Èáù + Êï∞Â≠ó)</option>
          <option value="analog">„Ç¢„Éä„É≠„Ç∞„ÅÆ„Åø (Èáù)</option>
          <option value="digital">„Éá„Ç∏„Çø„É´„ÅÆ„Åø (Êï∞Â≠ó)</option>
        </select>
      </div>

      <div class="setting-row">
        <label>„É°„Éº„Çø„Éº‰∏äÈôê (km/h)</label>
        <input type="number" id="input-scale" value="40" min="10" max="300">
      </div>

      <div class="setting-row">
        <button class="btn-action btn-reset" id="btn-reset-max">ÊúÄÈ´òÈÄüÂ∫¶„É™„Çª„ÉÉ„Éà</button>
        <button class="btn-action btn-reset" id="btn-reset-dist">Ëµ∞Ë°å„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà</button>
        <button class="btn-action btn-danger" id="btn-reset-all">ÂàùÊúüÂåñ (ÂÖ®„Éá„Éº„ÇøÊ∂àÂéª)</button>
      </div>

      <button class="btn-action btn-close" id="btn-close-settings">Èñâ„Åò„Çã</button>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- YouTube API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    /* =========================================
       GLOBAL STATE & UTILS
       ========================================= */
    let wakeLock = null;
    
    // --- Meter State ---
    const meterState = {
      currentSpeed: 0,
      maxSpeed: 0,
      distance: 0,
      movingTime: 0,
      calories: 0,
      currentAlt: null,
      userWeight: 60,
      
      // Settings
      clockColor: '#ffffff',
      meterColor: '#00ffcc',
      meterMax: 40,
      displayStyle: 'hybrid',
      showSeconds: false,

      lastLat: null, lastLng: null,
      mapMode: false
    };
    
    // --- Player State ---
    let allMediaItems = [];
    let currentPlaylist = [];
    let currentIndex = 0;
    let ytPlayer = null;

    // Wake Lock
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
        }
      } catch (err) { console.warn(err); }
    }
    
    /* =========================================
       METER LOGIC
       ========================================= */
    const els = {
      speed: document.getElementById('speed-val'),
      needle: document.getElementById('gauge-needle'),
      ticks: document.getElementById('gauge-ticks'),
      dist: document.getElementById('dist-val'),
      time: document.getElementById('time-val'),
      kcal: document.getElementById('kcal-val'),
      avg: document.getElementById('avg-val'),
      max: document.getElementById('max-val'),
      alt: document.getElementById('alt-val'),
      clock: document.getElementById('clock'),
      meterSec: document.getElementById('meter-section'),
      btnMap: document.getElementById('btn-map-toggle'),
      
      // Setting Inputs
      inputClockColor: document.getElementById('input-clock-color'),
      inputMeterColor: document.getElementById('input-meter-color'),
      inputStyle: document.getElementById('input-style'),
      inputScale: document.getElementById('input-scale'),
      inputWeight: document.getElementById('input-weight'),
      inputShowSeconds: document.getElementById('input-show-seconds')
    };

    let map = null, marker = null;

    function initMeter() {
      setInterval(updateClock, 1000);
      setInterval(tripTimer, 1000);
      loadMeterData(); // Load and Apply Settings
      startTracking();
    }

    function loadMeterData() {
      const saved = localStorage.getItem('cycle-tech-cinema-v2');
      if (saved) {
        const d = JSON.parse(saved);
        meterState.maxSpeed = d.maxSpeed || 0;
        meterState.distance = d.distance || 0;
        meterState.movingTime = d.movingTime || 0;
        meterState.calories = d.calories || 0;
        meterState.userWeight = d.userWeight || 60;
        
        meterState.clockColor = d.clockColor || '#ffffff';
        meterState.meterColor = d.meterColor || '#00ffcc';
        meterState.meterMax = d.meterMax || 40;
        meterState.displayStyle = d.displayStyle || 'hybrid';
        meterState.showSeconds = d.showSeconds || false;
      }
      applySettings();
      updateMeterUI();
    }

    function saveMeterData() {
      localStorage.setItem('cycle-tech-cinema-v2', JSON.stringify({
        maxSpeed: meterState.maxSpeed,
        distance: meterState.distance,
        movingTime: meterState.movingTime,
        calories: meterState.calories,
        userWeight: meterState.userWeight,
        
        clockColor: meterState.clockColor,
        meterColor: meterState.meterColor,
        meterMax: meterState.meterMax,
        displayStyle: meterState.displayStyle,
        showSeconds: meterState.showSeconds
      }));
    }

    function applySettings() {
      // Apply CSS Vars directly for dynamic colors
      // Note: In strict CSP or some frameworks, this might need refinement, but works for standard HTML
      // For needle color
      const styleSheet = document.styleSheets[0];
      // Instead of complex CSS manipulation, we use inline style or set properties on root if defined
      document.documentElement.style.setProperty('--accent-color', meterState.meterColor);
      
      els.clock.style.color = meterState.clockColor;
      els.inputClockColor.value = meterState.clockColor;
      els.inputMeterColor.value = meterState.meterColor;
      els.inputScale.value = meterState.meterMax;
      els.inputStyle.value = meterState.displayStyle;
      els.inputWeight.value = meterState.userWeight;
      els.inputShowSeconds.checked = meterState.showSeconds;

      // Style Toggle
      els.meterSec.classList.remove('hide-analog', 'hide-digital');
      if (meterState.displayStyle === 'analog') els.meterSec.classList.add('hide-digital');
      if (meterState.displayStyle === 'digital') els.meterSec.classList.add('hide-analog');

      drawTicks();
      updateClock(); // Immediate update
    }

    function drawTicks() {
      els.ticks.innerHTML = '';
      const max = parseInt(meterState.meterMax);
      const step = max <= 30 ? 5 : (max <= 60 ? 10 : 20);
      
      for (let i = 0; i <= max; i += step) {
        const el = document.createElement('div');
        el.className = 'gauge-tick-label';
        el.textContent = i;
        const angle = -135 + (i / max) * 270;
        const rad = (angle - 90) * (Math.PI / 180);
        const radius = 95; 
        el.style.left = `${140 + radius * Math.cos(rad)}px`;
        el.style.top = `${140 + radius * Math.sin(rad)}px`;
        els.ticks.appendChild(el);
      }
    }

    function updateMeter(speed) {
      els.speed.textContent = speed.toFixed(1);
      const max = parseInt(meterState.meterMax);
      let percent = speed / max;
      if (percent > 1) percent = 1;
      const deg = -135 + (percent * 270);
      els.needle.style.transform = `rotate(${deg}deg)`;
    }

    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      
      if (meterState.showSeconds) {
        const s = String(now.getSeconds()).padStart(2, '0');
        els.clock.textContent = `${h}:${m}:${s}`;
      } else {
        els.clock.textContent = `${h}:${m}`;
      }
    }

    function tripTimer() {
      if (meterState.currentSpeed >= 2.0) {
        meterState.movingTime++;
        // Kcal Calculation
        let mets = 4.0;
        if (meterState.currentSpeed >= 15) mets = 6.0;
        if (meterState.currentSpeed >= 20) mets = 8.0;
        if (meterState.currentSpeed >= 30) mets = 10.0;
        const kcalPerSec = (mets * meterState.userWeight) / 3600;
        meterState.calories += kcalPerSec;
        updateMeterUI();
      }
    }

    function updateMeterUI() {
      els.dist.textContent = meterState.distance.toFixed(2);
      els.max.textContent = meterState.maxSpeed.toFixed(1);
      els.kcal.textContent = Math.floor(meterState.calories);
      
      const h = Math.floor(meterState.movingTime / 3600);
      const m = Math.floor((meterState.movingTime % 3600) / 60);
      const s = meterState.movingTime % 60;
      els.time.textContent = `${h > 0 ? h+':' : ''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

      if (meterState.distance > 0 && meterState.movingTime > 0) {
        els.avg.textContent = (meterState.distance / (meterState.movingTime / 3600)).toFixed(1);
      }
      
      if (meterState.currentAlt !== null) els.alt.textContent = Math.round(meterState.currentAlt);
    }

    function calcDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; 
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function startTracking() {
      if (!navigator.geolocation) return;
      navigator.geolocation.watchPosition((pos) => {
        const { latitude, longitude, speed, accuracy, altitude } = pos.coords;
        let kmh = (speed || 0) * 3.6;
        if (kmh < 1.0) kmh = 0;
        
        meterState.currentSpeed = kmh;
        if (kmh > meterState.maxSpeed) meterState.maxSpeed = kmh;
        meterState.currentAlt = altitude;

        if (meterState.lastLat !== null && accuracy < 50 && kmh > 2.0) {
          const d = calcDistance(meterState.lastLat, meterState.lastLng, latitude, longitude);
          if (d > 0.002 && d < 0.1) meterState.distance += d;
        }

        meterState.lastLat = latitude;
        meterState.lastLng = longitude;
        
        saveMeterData();
        updateMeter(kmh);
        updateMeterUI();

        // Map Update
        if (meterState.mapMode && map) {
          if(!marker) marker = L.marker([latitude, longitude]).addTo(map);
          else marker.setLatLng([latitude, longitude]);
          map.setView([latitude, longitude]);
        }
      }, null, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    }

    /* =========================================
       SETTINGS EVENT LISTENERS
       ========================================= */
    els.inputClockColor.addEventListener('change', (e) => { meterState.clockColor = e.target.value; applySettings(); saveMeterData(); });
    els.inputMeterColor.addEventListener('change', (e) => { meterState.meterColor = e.target.value; applySettings(); saveMeterData(); });
    els.inputShowSeconds.addEventListener('change', (e) => { meterState.showSeconds = e.target.checked; updateClock(); saveMeterData(); });
    els.inputStyle.addEventListener('change', (e) => { meterState.displayStyle = e.target.value; applySettings(); saveMeterData(); });
    els.inputScale.addEventListener('change', (e) => { meterState.meterMax = e.target.value; applySettings(); saveMeterData(); });
    els.inputWeight.addEventListener('change', (e) => { meterState.userWeight = parseInt(e.target.value); saveMeterData(); });

    // Reset Buttons
    document.getElementById('btn-reset-max').addEventListener('click', () => {
      if(confirm('ÊúÄÈ´òÈÄüÂ∫¶„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) { meterState.maxSpeed = 0; saveMeterData(); updateMeterUI(); }
    });
    document.getElementById('btn-reset-dist').addEventListener('click', () => {
      if(confirm('Ëµ∞Ë°å„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü(Ë∑ùÈõ¢„ÉªÊôÇÈñì„Éª„Ç´„É≠„É™„Éº„ÉªÂπ≥Âùá)')) { 
        meterState.distance = 0; meterState.movingTime = 0; meterState.calories = 0; saveMeterData(); updateMeterUI(); 
      }
    });
    document.getElementById('btn-reset-all').addEventListener('click', () => {
      if(confirm('ÂÆåÂÖ®„Å´ÂàùÊúüÂåñ„Åó„Åæ„Åô„ÅãÔºü')) { localStorage.removeItem('cycle-tech-cinema-v2'); location.reload(); }
    });

    /* =========================================
       PLAYER LOGIC
       ========================================= */
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const json = JSON.parse(ev.target.result);
          // Handle both simple array and extension format
          allMediaItems = Array.isArray(json) ? json : (json.mediaItems || []);
          allMediaItems = allMediaItems.filter(i => i.site !== 'system');
          
          if (allMediaItems.length > 0) {
            setupFolderSelect();
            applyFilters();
            // Show overlay if not already playing
            document.getElementById('start-overlay').style.display = 'flex';
          } else {
            alert('ÂãïÁîª„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
          }
        } catch (err) { alert('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº'); }
      };
      reader.readAsText(file);
    });

    function setupFolderSelect() {
      const folders = new Set();
      allMediaItems.forEach(item => folders.add(item.folder || 'Manual'));
      const select = document.getElementById('folderSelect');
      select.innerHTML = '<option value="__ALL__">üìö „Åô„Åπ„Å¶„ÅÆÂãïÁîª</option>';
      Array.from(folders).sort().forEach(f => {
        const opt = document.createElement('option');
        opt.value = f; opt.innerText = `üìÅ ${f}`;
        select.appendChild(opt);
      });
      select.onchange = applyFilters;
    }

    document.getElementById('excludeNicoCheck').addEventListener('change', applyFilters);

    function applyFilters() {
      const folderName = document.getElementById('folderSelect').value;
      const excludeNico = document.getElementById('excludeNicoCheck').checked;
      
      let temp = allMediaItems;
      if (folderName !== '__ALL__') temp = temp.filter(i => (i.folder || 'Manual') === folderName);
      if (excludeNico) temp = temp.filter(i => i.site !== 'niconico');
      
      currentPlaylist = temp;
      renderPlaylist();
    }

    function renderPlaylist() {
      const container = document.getElementById('playlist-content');
      container.innerHTML = '';
      if (currentPlaylist.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">ÂãïÁîª„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }
      
      currentPlaylist.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `list-item ${index === currentIndex ? 'active' : ''}`;
        div.innerHTML = `
          <div class="list-thumb-box">
            <img src="${item.thumbnail}" class="list-thumb" loading="lazy">
            <div class="playing-overlay">‚ñ∂</div>
          </div>
          <div class="list-info">
            <div class="list-title">${item.title}</div>
            <div class="list-meta"><span>${item.site}</span><span>${item.folder||'Manual'}</span></div>
          </div>
        `;
        div.onclick = () => loadVideo(index);
        container.appendChild(div);
      });
      
      const active = container.querySelector('.active');
      if(active) active.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function loadVideo(index) {
      if (index < 0 || index >= currentPlaylist.length) return;
      currentIndex = index;
      const item = currentPlaylist[index];
      renderPlaylist();

      const container = document.getElementById('player-container');
      
      if (item.site === 'youtube') {
        const vid = getYouTubeId(item.url);
        // Reuse YT player if exists
        if (!ytPlayer || !container.querySelector('iframe')) {
          container.innerHTML = '<div id="yt-player-mount"></div>';
          ytPlayer = new YT.Player('yt-player-mount', {
            height: '100%', width: '100%', videoId: vid,
            playerVars: { 'playsinline': 1, 'autoplay': 1, 'rel': 0 },
            events: { 'onStateChange': onPlayerStateChange }
          });
        } else {
          ytPlayer.loadVideoById(vid);
        }
      } else {
        if(ytPlayer) { ytPlayer.destroy(); ytPlayer = null; }
        let html = '';
        if (item.site === 'niconico') {
           const nid = item.url.split('/').pop();
           html = `<iframe src="https://embed.nicovideo.jp/watch/${nid}?jsapi=1&autoplay=1" allow="autoplay; fullscreen" style="width:100%;height:100%;border:none;"></iframe>`;
        } else {
           html = `<iframe src="${item.url}" allowfullscreen style="width:100%;height:100%;border:none;"></iframe>`;
        }
        container.innerHTML = html;
      }
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) playNext();
    }
    
    function getYouTubeId(url) {
      try {
        const u = new URL(url);
        return u.searchParams.get('v') || url.split('/').pop();
      } catch(e) { return ''; }
    }
    
    function playNext() {
      if(currentPlaylist.length === 0) return;
      currentIndex = (currentIndex + 1) % currentPlaylist.length;
      loadVideo(currentIndex);
    }
    function playPrev() {
      if(currentPlaylist.length === 0) return;
      currentIndex = (currentIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
      loadVideo(currentIndex);
    }

    document.getElementById('btnNext').onclick = playNext;
    document.getElementById('btnPrev').onclick = playPrev;

    /* =========================================
       UI CONTROLS
       ========================================= */
    // Overlay Start
    document.getElementById('btnUserStart').onclick = () => {
      document.getElementById('start-overlay').style.display = 'none';
      requestWakeLock();
      if(currentPlaylist.length > 0) loadVideo(0);
    };

    // Map Toggle
    els.btnMap.addEventListener('click', function() {
      meterState.mapMode = !meterState.mapMode;
      els.meterSec.classList.toggle('map-active', meterState.mapMode);
      this.textContent = meterState.mapMode ? 'Hide MAP' : 'Show MAP';
      
      if (meterState.mapMode && !map) {
        map = L.map('map-view', {zoomControl:false}).setView([35.6812, 139.7671], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OSM', maxZoom: 19
        }).addTo(map);
        if(meterState.lastLat) map.setView([meterState.lastLat, meterState.lastLng]);
      }
    });

    // Fullscreen
    document.getElementById('btn-fullscreen').addEventListener('click', () => {
      if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
      else document.exitFullscreen();
    });

    // Settings Modal
    document.getElementById('btn-settings').addEventListener('click', () => {
      document.getElementById('settings-modal').style.display = 'flex';
    });
    document.getElementById('btn-close-settings').addEventListener('click', () => {
      document.getElementById('settings-modal').style.display = 'none';
    });

    // Initialization
    initMeter();

  </script>
</body>
</html>
